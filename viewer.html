<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Viewer • Civic Compass</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .viewer-header{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.08);position:sticky;top:0;background:var(--bg, #fff);z-index:10}
    .viewer-back{appearance:none;border:1px solid rgba(0,0,0,.15);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:600}
    .viewer-title{font-weight:700}
    .viewer-frame{width:100%;height:calc(100vh - 56px);border:0}
    .viewer-img{max-width:100%;height:auto;display:block;margin:0 auto;padding:12px}
    .viewer-note{padding:12px 14px;color:rgba(0,0,0,.65)}
  </style>
</head>
<body>
  <div class="viewer-header">
    <button class="viewer-back" id="backBtn">← Back</button>
    <div class="viewer-title" id="title">Viewer</div>
  </div>
  <div id="content"></div>

  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const file = params.get('file') || '';
      const title = params.get('title') || (file ? file.split('/').pop() : 'Viewer');
      document.getElementById('title').textContent = decodeURIComponent(title);

      const content = document.getElementById('content');
      const safeFile = file.replace(/^\/+/, ''); // relative
      const lower = safeFile.toLowerCase();

      const backBtn = document.getElementById('backBtn');
      backBtn.addEventListener('click', () => {
        // Prefer history when it will go back to the app, otherwise go home.
        if (history.length > 1) { history.back(); }
        else { location.href = './index.html'; }
      });

      if (!safeFile) {
        content.innerHTML = '<div class="viewer-note">No file provided.</div>';
        return;
      }

      // PDFs: iframe works in most browsers; iOS will still open its viewer but we keep a back button page.
      if (lower.endsWith('.pdf')) {
        const iframe = document.createElement('iframe');
        iframe.className = 'viewer-frame';
        iframe.src = './' + safeFile;
        iframe.title = title;
        content.appendChild(iframe);
        return;
      }

      // Images
      if (lower.match(/\.(png|jpg|jpeg|webp|gif)$/)) {
        const img = document.createElement('img');
        img.className = 'viewer-img';
        img.src = './' + safeFile;
        img.alt = title;
        content.appendChild(img);
        return;
      }

      // Fallback: open in same window
      const iframe = document.createElement('iframe');
      iframe.className = 'viewer-frame';
      iframe.src = './' + safeFile;
      iframe.title = title;
      content.appendChild(iframe);
    })();
  </script>

<script>
(async function(){
  const params = new URLSearchParams(location.search);
  const file = params.get('file');
  const viewer = document.getElementById('viewer');
  const dl = document.getElementById('downloadLink');
  if(!file){ return; }

  function showImage(src){
    viewer.innerHTML = '';
    const img = document.createElement('img');
    img.src = src;
    img.alt = 'Document';
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '0 auto';
    viewer.appendChild(img);
  }

  // Always show an explicit open/download link
  dl.href = file;
  dl.target = '_blank';
  dl.rel = 'noopener';
  dl.style.display = 'inline-block';

  const lower = file.toLowerCase();
  if(lower.endsWith('.pdf')){
    // Prefer PNG preview to avoid iOS/PWA PDF hijack
    try{
      const resp = await fetch('data/technical_drawings.json');
      const data = await resp.json();
      const name = file.split('/').pop();
      const match = (data.items || []).find(it => ((it.pdf || it.file || it.path || it.href || '')).split('/').pop() === name);
      if(match && match.preview){
        showImage(match.preview);
        return;
      }
    }catch(e){}
    viewer.innerHTML = '<p style="padding:12px;">Preview unavailable. Use Open PDF.</p>';
    return;
  }

  // Images: show directly
  showImage(file);
})();
</script>
<!-- TECH_DRAWINGS_PREVIEW_MAP -->


<script>
// BACK_TO_HOME_HARD
(function(){
  const btn = document.getElementById('backBtn') || document.querySelector('[data-back], .back-button, .btn-back, a.back');
  if(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      window.location.href = './index.html';
    });
  }
})();
</script>
</body>
</html>
